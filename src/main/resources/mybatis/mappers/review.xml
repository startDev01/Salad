<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="review">
	
	<!-- 1-1. 전체목록조회 + 최다조회수 게시글 상단고정 + 페이징(23.07.16.) -->
	<select id="selectAllReviewList" parameterType="com.proj.salad.review.vo.Criteria" resultType="com.proj.salad.review.vo.ReviewVO">
		<![CDATA[			
			SELECT * FROM (
			    SELECT level, re_articleNO, re_parentNO, LPAD(' ', 4*(level-1)) || re_title re_title, re_content, userId, re_writeDate, re_viewCnt, rownum rno
			    FROM SHOP_REVIEW
			    WHERE re_parentNO=0
			    START WITH re_parentNO=0
			    CONNECT BY PRIOR re_articleNO=re_parentNO
			    ORDER BY re_viewCnt DESC
			)
			WHERE ROWNUM<=3

			UNION ALL

			SELECT * FROM (
			    SELECT level, re_articleNO, re_parentNO, LPAD(' ', 4*(level-1)) || re_title re_title, re_content, userId, re_writeDate, re_viewCnt, rownum rno
			    FROM shop_review
			    WHERE re_articleNO>=0
			    START WITH re_parentNO=0
			    CONNECT BY PRIOR re_articleNO=re_parentNO
			    ORDER SIBLINGS BY DECODE(re_viewCnt,'max(re_noti)',1), re_articleNO DESC
			    )
			WHERE rno BETWEEN #{rowStart} and #{rowEnd}
		]]>
	</select>
	
	<!-- 1-2. 게시물 총 개수(23.07.16.) -->
	<select id="getTotal" resultType="int">
		select count(re_articleNO) from shop_review
	</select>
	
	<!-- 2-1. 리뷰게시판 글쓰기(23.07.16.) -->
	<insert id="insertReview" parameterType="com.proj.salad.review.vo.ReviewVO">
		<![CDATA[
			INSERT INTO shop_review(re_articleNO, re_parentNO, re_title, userId, re_content, re_writeDate, re_viewCnt)
			VALUES(
			(SELECT MAX(re_articleNO)+1 from shop_review), 0, #{re_title}, #{userId}, #{re_content}, SYSDATE, #{re_viewCnt})
		]]>
	</insert>
	
	<!-- 2-2. 파일 업로드(23.07.20.) -->
	<insert id="insertReviewImg" parameterType="java.util.Map">
      <![CDATA[
		INSERT INTO review_image(re_imgNo, userId, re_articleNO, RE_ORIGINALFILENAME, re_storedFileName, re_fileSize)
		VALUES(RE_IMG_SEQ.NEXTVAL, #{USERID}, #{RE_ARTICLENO}, #{RE_ORIGINALFILENAME}, #{RE_STOREDFILENAME}, #{RE_FILESIZE})
		]]>
   </insert>
	
	<!-- 2-3. 파일업로드 DB 저장 시, 게시물 번호 가져오기(23.07.20.) -->
	<select id="selectReview"  parameterType="com.proj.salad.review.vo.ReviewVO"  resultType="String">
		SELECT re_articleNO 
		from shop_review 
		WHERE userId=#{userId} and  re_title=#{re_title}
	</select>

	<!-- 3-1. 게시물 상세조회(23.07.16.) -->
	<select id="detailReview" resultType="com.proj.salad.review.vo.ReviewVO">
		<![CDATA[
			SELECT re_title, userId, re_content, re_writeDate, re_viewCnt, re_articleNO
			FROM shop_review
			WHERE re_articleNO = #{re_articleNO}
		]]>
	</select>
	
	<!-- 이미지 정보 가져오기 -->
	<select id="detailImg" parameterType="String" resultType="com.proj.salad.review.vo.Review_imageVO">
	<![CDATA[
			SELECT *
            FROM review_image
		    WHERE re_articleNO = #{RE_ARTICLENO}
	]]>
	</select>
	
	<!-- 3-2. 조회수 증가(23.07.16.) -->
	<update id="updateCnt" parameterType="int">
		<![CDATA[
			UPDATE shop_review
			SET re_viewCnt = re_viewCnt + 1
			WHERE re_articleNO = #{re_articleNO}
		]]>
	</update>
	
	<!-- 하유리: 4-2. 게시물 수정하기(23.07.18.) -->
	<update id="updateReview" parameterType="com.proj.salad.review.vo.ReviewVO">
		<![CDATA[
			UPDATE shop_review 
			SET
				userId=#{userId},
				re_title = #{re_title},
				re_content = #{re_content}
			WHERE re_articleNO = #{re_articleNO}
		]]>
	</update>

	<!-- 하유리: 5. 게시물 삭제하기(23.07.18.) -->
	<delete id="deleteReview">
		<![CDATA[
			DELETE FROM shop_review
			WHERE re_articleNO= #{re_articleNO}
		]]>
	</delete>
	
	<!-- 하유리: 6-2. 답변 작성(23.07.18.) -->
	<insert id="replyReview" parameterType="com.proj.salad.review.vo.ReviewVO">
		<![CDATA[
			INSERT INTO shop_review(re_articleNO, re_parentNO, re_title, userId, re_content, re_writeDate, re_viewCnt)
			VALUES(
			(SELECT MAX(re_articleNO)+1 from shop_review), #{re_articleNO}, #{re_title}, #{userId}, #{re_content}, SYSDATE, #{re_viewCnt})
		]]>
	</insert>
</mapper>